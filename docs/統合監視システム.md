# 統合監視システム

## 概要

統合監視システムは、NotionWorkflowToolsの全プロジェクト（HETEMLMonitor、NotionLinker、MovableTypeRebuilder）の状態を一箇所で監視し、問題を検出して自動復旧を実行するシステムです。

## 機能

### 1. **自動監視**
- **HETEMLMonitor**: 5分間隔で監視
- **NotionLinker**: 15分間隔で監視
- **MovableTypeRebuilder**: 24時間間隔で監視（毎月1日のみ実行）

### 2. **問題検出**
- launchdサービスの状態確認
- ログファイルのエラー検出
- プロセスの停止検出

### 3. **自動復旧**
- 停止したサービスの自動再起動
- エラー発生時の自動復旧
- 復旧成功/失敗の通知

### 4. **通知機能**
- 問題検出時のメール通知
- 自動復旧完了の通知
- 復旧失敗時のアラート

## セットアップ

### 1. **統合監視システムのセットアップ**

```bash
cd /Users/takuhito/NotionWorkflowTools
python scripts/setup_service_monitor.py
```

### 2. **設定ファイルの確認**

設定ファイルは `config/monitor_config.json` に作成されます：

```json
{
  "email": {
    "smtp_server": "smtp.gmail.com",
    "smtp_port": 587,
    "username": "your-email@gmail.com",
    "password": "your-app-password",
    "from_email": "your-email@gmail.com",
    "to_email": "your-email@gmail.com"
  },
  "notification": {
    "enabled": true,
    "check_interval": 300
  }
}
```

## 使用方法

### 1. **手動実行**

```bash
# 1回だけ実行
python scripts/monitor_all_services.py

# 継続実行
python scripts/monitor_all_services.py --continuous
```

### 2. **サービスの状態確認**

```bash
# 全サービスの状態確認
python scripts/setup_service_monitor.py --status
```

### 3. **ログの確認**

```bash
# 統合監視システムのログ
tail -f logs/service_monitor.log

# launchdのログ
tail -f ~/Library/Logs/service-monitor.out.log
tail -f ~/Library/Logs/service-monitor.err.log
```

## 監視対象サービス

### 1. **HETEMLMonitor**
- **plist**: `com.user.heteml-monitor.plist`
- **監視間隔**: 5分
- **ログディレクトリ**: `HETEMLMonitor/logs/`

### 2. **NotionLinker**
- **plist**: `com.tkht.notion-linker.plist`
- **監視間隔**: 15分
- **ログディレクトリ**: `~/Library/Logs/`

### 3. **MovableTypeRebuilder**
- **plist**: `com.user.movabletype-rebuilder.plist`
- **監視間隔**: 24時間（毎月1日のみ実行）
- **ログディレクトリ**: `MovableTypeRebuilder/logs/`

## 通知の種類

### 1. **問題検出通知**
```
件名: [統合監視] サービス監視アラート
内容: 監視対象サービスの一部に問題があります。
```

### 2. **自動復旧完了通知**
```
件名: [統合監視] HETEMLMonitor 自動復旧完了
内容: HETEMLMonitor の問題を検出し、自動復旧を実行しました。
```

### 3. **復旧失敗通知**
```
件名: [統合監視] NotionLinker 自動復旧失敗
内容: NotionLinker の問題を検出しましたが、自動復旧に失敗しました。
手動での確認が必要です。
```

## トラブルシューティング

### 1. **統合監視システムが動作しない**

```bash
# サービスの状態確認
launchctl list | grep service-monitor

# 手動実行でテスト
python scripts/monitor_all_services.py

# ログの確認
tail -f ~/Library/Logs/service-monitor.err.log
```

### 2. **通知が送信されない**

```bash
# 設定ファイルの確認
cat config/monitor_config.json

# 環境変数の確認
echo $EMAIL_USERNAME
echo $EMAIL_PASSWORD
```

### 3. **特定のサービスが復旧しない**

```bash
# 個別サービスの状態確認
launchctl print gui/$(id -u)/com.user.heteml-monitor
launchctl print gui/$(id -u)/com.tkht.notion-linker
launchctl print gui/$(id -u)/com.user.movabletype-rebuilder
```

## 設定のカスタマイズ

### 1. **監視間隔の変更**

`scripts/monitor_all_services.py` の `services` 辞書で各サービスの `check_interval` を変更：

```python
'heteml_monitor': {
    'check_interval': 300,  # 5分 → 変更可能
},
```

### 2. **通知設定の変更**

`config/monitor_config.json` で通知設定を変更：

```json
{
  "notification": {
    "enabled": true,
    "check_interval": 300  # 監視間隔
  }
}
```

### 3. **エラー検出の調整**

`scripts/monitor_all_services.py` の `error_indicators` リストで検出するエラーキーワードを調整：

```python
error_indicators = ['error', 'Error', 'ERROR', 'failed', 'Failed', 'FAILED']
```

## セキュリティ

### 1. **環境変数の管理**
- メール認証情報は環境変数で管理
- `.env`ファイルに保存しない

### 2. **ログファイルの権限**
- ログファイルは適切な権限で作成
- 機密情報はログに出力しない

### 3. **launchdの設定**
- ユーザーレベルのlaunchdを使用
- システム全体への影響を最小化

## 今後の拡張

### 1. **追加機能**
- Slack通知の追加
- LINE通知の追加
- Webhook通知の追加

### 2. **監視項目の拡張**
- ディスク使用量の監視
- メモリ使用量の監視
- ネットワーク接続の監視

### 3. **ダッシュボード**
- Webベースの監視ダッシュボード
- リアルタイム状態表示
- 履歴グラフの表示

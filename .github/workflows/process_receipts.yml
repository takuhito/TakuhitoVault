name: Process Receipts

on:
  schedule:
    # 毎日午前9時に実行
    - cron: '0 9 * * *'
  workflow_dispatch:  # 手動実行も可能

jobs:
  process-receipts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Set up environment variables
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
        GOOGLE_CLOUD_CREDENTIALS: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}
        GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
      run: |
        # Google Drive認証情報をファイルに保存
        echo '${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}' > google_drive_credentials.json
        echo '${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}' > google_cloud_credentials.json
        
        # 環境変数を設定
        echo "GOOGLE_DRIVE_CREDENTIALS_FILE=google_drive_credentials.json" >> $GITHUB_ENV
        echo "GOOGLE_CLOUD_CREDENTIALS_FILE=google_cloud_credentials.json" >> $GITHUB_ENV
        
    - name: Run receipt processor
      run: |
        cd receipt-processor
        python main.py
        
    - name: Upload logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: processing-logs
        path: |
          receipt_processor.log
          google_drive_credentials.json
          google_cloud_credentials.json
        retention-days: 7

